# StaffMart - iOSアプリケーション
## 要件定義書 & 基本設計書

---

## 要件定義書

### 1. 概要
本アプリケーション「StaffMart」は、社員証を利用したログイン機能とQRコードを活用した商品購入システムを提供するiOSアプリです。SwiftUIを用いて開発し、直感的で使いやすいUIを実現します。本システムは社内販売向けに設計されており、社員が簡単に商品を購入できるようにします。

### 2. 機能要件

#### 2.1 社員証をかざしてログイン
* NFCを利用し、社員証をかざしてログイン可能。
* 社員マスタデータをCSVファイルとして取り込み、認証に利用。
* 不正アクセス防止のため、一定時間未操作時に自動ログアウト。
* NFCに対応していないデバイス（iPhone 6s以前）での起動時、非対応メッセージを表示。
* 非対応デバイスでは代替ログイン方法（社員IDの手動入力など）を提供。

#### 2.2 QRコードの読み取り
* 商品情報がJSON形式で埋め込まれたQRコードをスキャン。
* QRコードには以下の情報を含む。
   * **商品ID**（一意の識別子）
   * **商品名**
   * **カテゴリ**（例：靴、服、小物 など）
   * **価格**
   * **サイズの選択肢**（例：S, M, L, XL、または靴のサイズ等）
   * **製造元またはブランド名**
   * **追加情報（備考欄）**
* 読み取ったデータをもとに購入処理を進める。
* QRコードが無効な場合はエラーメッセージを表示。

**QRコード内のJSONサンプル**

```json
{
  "product_id": "A12345",
  "name": "ランニングシューズ",
  "category": "靴",
  "price": 9800,
  "sizes": ["25.0", "25.5", "26.0", "26.5", "27.0"],
  "brand": "スポーツメーカーX",
  "notes": "防水仕様"
}
```

#### 2.3 商品選択・カート機能
* 読み取った商品データに基づき、数量やサイズを選択。
* 「カートに追加」または「直接購入」の選択が可能。
* カートに追加した場合は、引き続き別のQRコードをスキャン可能。
* カート内商品の削除や数量変更が可能。

#### 2.4 購入処理
* 支払い方法を「現金」または「給与天引き」から選択。
* 購入完了後、購入データを内部でCSVファイルとして記録。
* 購入のたびにCSVファイルへ追記保存。
* 購入完了後に確認メッセージを表示。

#### 2.5 エラーハンドリング
* NFCスキャン失敗時のリトライ機能。
* ネットワーク障害時のエラーメッセージ。
* CSV入出力のエラーチェック機能。

#### 2.6 ログ機能
* アプリの動作状況を記録するログ機能を実装。
* 以下の情報をログとして記録：
   * 操作日時
   * 実行された操作の種類（ログイン、QRスキャン、購入など）
   * 操作結果（成功/失敗）
   * エラーが発生した場合はエラー内容
   * 関連するデータID（社員ID、商品IDなど）
* ログはアプリ内部にテキストファイルとして保存。
* トラブルシューティング時に管理者がアクセス可能。

---

## 基本設計書

### 1. 画面構成とフロー

#### 1.1 ログイン画面
* デバイスのNFC対応状況を確認。
* NFC対応デバイス：「社員証をスキャンしてください」の文言と関連する画像を表示。
* NFC非対応デバイス：非対応メッセージと代替ログイン方法（社員ID入力フォームなど）を表示。
* 認証成功後、QRコードスキャン画面へ遷移。
* 認証失敗時はエラーメッセージを表示し、再スキャンを促す。

#### 1.2 QRコードスキャン画面
* 画面の一部にQRコードスキャナーを表示（フルスクリーンではなく、エイミング用ガイドを含む）。
* 商品のQRコードをスキャン。
* スキャン成功時は商品情報表示画面へ遷移。
* 無効なQRコードがスキャンされた場合はエラーを表示。

#### 1.3 商品情報表示画面
* 読み取った商品情報（商品名、価格、サイズなど）を表示。
* サイズと数量の選択UIを提供。
* 「カートに追加」または「直接購入」ボタンを表示。
* 「カートに追加」選択時はQRコードスキャン画面に戻る。
* 「直接購入」選択時はカート・決済画面に遷移。

#### 1.4 カート・決済画面
* カートに追加された商品を一覧表示。
* 商品の削除や数量変更が可能。
* 支払い方法を「現金」または「給与天引き」から選択。
* 「購入を確定」ボタンで決済を完了し、購入完了画面へ遷移。
* 決済後、購入データをCSVに記録。

#### 1.5 購入完了画面
* 購入内容の確認と「新しい購入を開始」ボタンを表示。
* ボタン押下でQRコードスキャン画面へ戻る。
* 購入履歴の簡易表示。

#### 1.6 購入履歴画面
* 過去の購入履歴を表示。
* 日付やカテゴリでフィルタリング可能。
* QRコードスキャン画面に戻るボタンを配置。

### 2. CSVに記録する内容
* **購入日時**（YYYY-MM-DD HH:MM:SS）
* **社員ID**（ログイン時に取得）
* **社員名**（CSVの社員マスタから取得）
* **商品ID**（一意の識別子）
* **商品名**
* **カテゴリ**（靴、服、小物 など）
* **サイズ**（S, M, L, XL など）
* **数量**
* **単価**
* **合計金額**（単価 × 数量）
* **支払い方法**（現金 / 給与天引き）
* **決済ステータス**（成功 / 失敗）
* **製造元またはブランド名**
* **追加情報（備考）**

### 3. ログ記録の仕様
* **ログファイル名**: app_log_YYYYMMDD.txt（日付ごとに新規ファイル）
* **ログ形式**: [日時] [ログレベル] [操作種別] [ユーザーID] [内容]
* **ログレベル**:
  * INFO: 通常の操作情報
  * WARNING: 注意が必要な状況
  * ERROR: エラー発生時
  * CRITICAL: 重大なエラー発生時
* **ログ出力場所**: アプリのドキュメントディレクトリ内の「Logs」フォルダ
* **ログの保持期間**: 30日間（古いログは自動削除）
* **出力例**:
  ```
  [2025-03-13 14:22:15] [INFO] [LOGIN] [E12345] [ログイン成功]
  [2025-03-13 14:23:05] [INFO] [SCAN] [E12345] [商品スキャン成功: A12345]
  [2025-03-13 14:25:30] [INFO] [PURCHASE] [E12345] [購入完了: 合計¥9,800]
  [2025-03-13 14:30:45] [ERROR] [NFC] [E12345] [NFCスキャン失敗: タイムアウト]
  ```

### 4. 技術的要素
* **SwiftUI** を用いたモダンなUI設計。
* **Core NFC**（NFCログイン機能の実装）。
* **AVFoundation**（QRコード読み取り機能の実装）。
* **CSVの入出力処理**（社員マスタのインポート、購入履歴の保存）。
* **JSONデータの解析**（QRコード内の商品情報の処理）。
* **データの永続化処理**（購入履歴のローカル保存）。
* **ログ機能**（OSLog及びFileManagerを使用）。

本設計により、社員がスムーズにログインし、QRコードを活用して簡単に商品を購入できる環境を提供します。エラーハンドリングとログ機能を強化し、安定した動作と問題発生時の追跡を実現します。
